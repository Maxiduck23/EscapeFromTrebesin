{% extends "main/base.html" %}
{% load static %}

{% block title %}Rezervace | Escape From T≈ôebe≈°√≠n{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'styles/booking.css' %}">
{% endblock %}

{% block content %}
<div class="booking-page">
    <div class="booking-container">
        <div class="booking-header">
            <h1>Rezervace √∫nikov√© hry</h1>
            <p>Vyberte si m√≠stnost, datum a ƒças pro v√°≈° nezapomenuteln√Ω z√°≈æitek</p>
        </div>
        
        <div class="booking-form-container">
            <!-- Progress Bar -->
            <div class="booking-progress">
                <div class="progress-steps">
                    <div class="progress-step active" id="step-1">
                        <div class="step-number"><span>1</span></div>
                        <div class="step-label">V√Ωbƒõr m√≠stnosti</div>
                    </div>
                    <div class="progress-step" id="step-2">
                        <div class="step-number"><span>2</span></div>
                        <div class="step-label">Datum a ƒças</div>
                    </div>
                    <div class="progress-step" id="step-3">
                        <div class="step-number"><span>3</span></div>
                        <div class="step-label">Osobn√≠ √∫daje</div>
                    </div>
                    <div class="progress-step" id="step-4">
                        <div class="step-number"><span>4</span></div>
                        <div class="step-label">Potvrzen√≠</div>
                    </div>
                </div>
            </div>
            
            <!-- Booking Content -->
            <div class="booking-content">
                <!-- Step 1: Room Selection -->
                <div class="booking-step" id="booking-step-1">
                    <h2>Vyberte si m√≠stnost</h2>
                    <div class="room-selection">
                        {% for room in escape_rooms %}
                        <div class="room-option js-interactable" 
                             data-room-id="{{ room.id_escape_room }}" 
                             data-price="{{ room.cena }}"
                             role="button" 
                             tabindex="0"
                             aria-label="Vybrat m√≠stnost {{ room.nazev }}">
                            <div class="room-image" style="background-image: url('{% static 'img/' %}{{ room.tema }}');"></div>
                            <h3 class="room-name">{{ room.nazev }}</h3>
                            <div class="room-info">
                                <div class="room-difficulty">{{ room.obtiznost }}</div>
                                <div class="room-price">{{ room.cena }} Kƒç</div>
                            </div>
                            <div class="room-features">
                                <div class="room-feature">üíÄ {{ room.strasidelnost }}</div>
                                <div class="room-feature">üë∂ {{ room.doporuceny_vek }}</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Step 2: Date and Time Selection -->
                <div class="booking-step" id="booking-step-2" style="display: none;">
                    <h2>Vyberte datum a ƒças</h2>
                    <div class="date-selection">
                        <div class="calendar-container">
                            <div class="calendar-header">
                                <div class="calendar-title" id="calendar-title">Prosinec 2024</div>
                                <div class="calendar-nav">
                                    <button type="button" 
                                            id="prev-month" 
                                            class="js-interactable" 
                                            aria-label="P≈ôedchoz√≠ mƒõs√≠c">‚Äπ</button>
                                    <button type="button" 
                                            id="next-month" 
                                            class="js-interactable" 
                                            aria-label="Dal≈°√≠ mƒõs√≠c">‚Ä∫</button>
                                </div>
                            </div>
                            <div class="calendar-grid" id="calendar-grid" role="grid" aria-label="Kalend√°≈ô pro v√Ωbƒõr data">
                                <!-- Calendar will be generated by JavaScript -->
                            </div>
                        </div>

                        <div class="time-slots-container">
                            <h3 class="time-slots-header">Dostupn√© ƒçasy</h3>
                            <div class="time-slots-grid" id="time-slots" role="radiogroup" aria-label="Dostupn√© ƒçasy">
                                <!-- Time slots will be loaded by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Personal Information -->
                <div class="booking-step" id="booking-step-3" style="display: none;">
                    <h2>Kontaktn√≠ √∫daje</h2>
                    <form class="personal-info-form js-interactable" id="personal-info-form" method="post" novalidate>
                        {% csrf_token %}
                        <div class="form-row">
                            <div class="form-group">
                                <label for="first-name">Jm√©no <span>*</span></label>
                                <input type="text" 
                                       id="first-name" 
                                       class="form-control js-interactable" 
                                       placeholder="Jan" 
                                       required 
                                       autocomplete="given-name"
                                       aria-describedby="first-name-error">
                                <div id="first-name-error" class="error-message" aria-live="polite"></div>
                            </div>
                            <div class="form-group">
                                <label for="last-name">P≈ô√≠jmen√≠ <span>*</span></label>
                                <input type="text" 
                                       id="last-name" 
                                       class="form-control js-interactable" 
                                       placeholder="Nov√°k" 
                                       required 
                                       autocomplete="family-name"
                                       aria-describedby="last-name-error">
                                <div id="last-name-error" class="error-message" aria-live="polite"></div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="email">E-mail <span>*</span></label>
                            <input type="email" 
                                   id="email" 
                                   class="form-control js-interactable" 
                                   placeholder="jan.novak@email.cz" 
                                   required 
                                   autocomplete="email"
                                   aria-describedby="email-error">
                            <div id="email-error" class="error-message" aria-live="polite"></div>
                        </div>

                        <div class="form-group">
                            <label for="phone">Telefon <span>*</span></label>
                            <input type="tel" 
                                   id="phone" 
                                   class="form-control js-interactable" 
                                   placeholder="+420 123 456 789" 
                                   required 
                                   autocomplete="tel"
                                   aria-describedby="phone-error">
                            <div id="phone-error" class="error-message" aria-live="polite"></div>
                        </div>

                        <div class="form-group">
                            <label for="players">Poƒçet hr√°ƒç≈Ø <span>*</span></label>
                            <select id="players" 
                                    class="form-control js-interactable" 
                                    required 
                                    aria-describedby="players-error">
                                <option value="">Vyberte poƒçet hr√°ƒç≈Ø</option>
                                <option value="2">2 hr√°ƒçi</option>
                                <option value="3">3 hr√°ƒçi</option>
                                <option value="4">4 hr√°ƒçi</option>
                                <option value="5">5 hr√°ƒç≈Ø</option>
                                <option value="6">6 hr√°ƒç≈Ø</option>
                            </select>
                            <div id="players-error" class="error-message" aria-live="polite"></div>
                        </div>

                        <div class="form-group">
                            <label for="notes">Pozn√°mky (nepovinn√©)</label>
                            <textarea id="notes" 
                                      class="form-control js-interactable" 
                                      rows="4" 
                                      placeholder="M√°te nƒõjak√© speci√°ln√≠ po≈æadavky nebo pozn√°mky?"
                                      autocomplete="off"></textarea>
                        </div>

                        <div class="form-note">
                            <strong>Pozn√°mka:</strong> Platba prob√≠h√° na m√≠stƒõ v hotovosti nebo kartou.
                            Rezervaci je mo≈æn√© zru≈°it nejpozdƒõji 24 hodin p≈ôedem.
                        </div>
                    </form>
                </div>

                <!-- Step 4: Confirmation -->
                <div class="booking-step" id="booking-step-4" style="display: none;">
                    <div class="booking-success">
                        <div class="success-icon" role="img" aria-label="√öspƒõch">‚úì</div>
                        <h2 class="success-message">Rezervace byla √∫spƒõ≈°nƒõ dokonƒçena!</h2>
                        <p class="success-details">
                            Na v√°≈° e-mail jsme zaslali potvrzen√≠ rezervace s v≈°emi d≈Øle≈æit√Ωmi informacemi.
                            <br>Tƒõ≈°√≠me se na v√°s!
                        </p>
                        <div class="success-code" role="status" aria-live="polite">
                            K√≥d rezervace: <span id="booking-code">EFT2024XXXX</span>
                        </div>
                        <a href="{% url 'main:home' %}" 
                           class="btn js-interactable" 
                           role="button">Zpƒõt na hlavn√≠ str√°nku</a>
                    </div>
                </div>

                <!-- Booking Summary (visible in steps 2-4) -->
                <div class="booking-summary" id="booking-summary" style="display: none;" role="region" aria-label="Shrnut√≠ rezervace">
                    <h3 class="summary-title">Shrnut√≠ rezervace</h3>
                    <div class="summary-item">
                        <span class="summary-label">M√≠stnost:</span>
                        <span class="summary-value" id="summary-room" aria-live="polite">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Datum:</span>
                        <span class="summary-value" id="summary-date" aria-live="polite">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">ƒåas:</span>
                        <span class="summary-value" id="summary-time" aria-live="polite">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Poƒçet hr√°ƒç≈Ø:</span>
                        <span class="summary-value" id="summary-players" aria-live="polite">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Celkov√° cena:</span>
                        <span class="summary-value" id="summary-price" aria-live="polite">-</span>
                    </div>
                </div>

                <!-- Navigation Buttons -->
                <div class="booking-navigation" id="booking-navigation" role="navigation" aria-label="Navigace rezervace">
                    <button type="button" 
                            class="nav-btn btn-back js-interactable" 
                            id="btn-back" 
                            style="display: none;"
                            aria-label="Zpƒõt na p≈ôedchoz√≠ krok">
                        Zpƒõt
                    </button>
                    <button type="button" 
                            class="nav-btn btn-next js-interactable" 
                            id="btn-next" 
                            disabled
                            aria-label="Pokraƒçovat na dal≈°√≠ krok">
                        Pokraƒçovat
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loading-overlay" role="status" aria-label="Naƒç√≠t√°n√≠" aria-live="polite">
    <div class="loading-spinner" aria-hidden="true"></div>
</div>

<!-- Error Message Container for Screen Readers -->
<div id="error-announcer" aria-live="assertive" aria-atomic="true" style="position: absolute; left: -10000px; width: 1px; height: 1px; overflow: hidden;"></div>
{% endblock %}

{% block extra_js %}
<script>
    // OPRAVEN√Å KONFIGURACE - lep≈°√≠ error handling a debug info
    window.bookingConfig = {
        urls: {
            getAvailableSlots: "{% url 'booking:get_available_slots' %}",
            bookingSubmit: "{% url 'booking:booking' %}",
        },
        csrfToken: "{{ csrf_token }}",
        debug: {% if settings.DEBUG %}true{% else %}false{% endif %},
        locale: 'cs-CZ',
        timezone: 'Europe/Prague'
    };
    
    // Zpƒõtn√° kompatibilita
    window.bookingUrls = window.bookingConfig.urls;
    window.bookingUrls.csrfToken = window.bookingConfig.csrfToken;
    
    if (window.bookingConfig.debug) {
        console.log('üîß Booking configuration loaded:', window.bookingConfig);
        console.log('üåç User timezone:', Intl.DateTimeFormat().resolvedOptions().timeZone);
        console.log('üìÖ Current date:', new Date().toLocaleDateString('cs-CZ'));
    }
</script>
<script src="{% static 'js/booking.js' %}"></script>

{% if settings.DEBUG %}
<!-- DEBUG PANEL - vylep≈°en√Ω -->
<div class="debug-info" id="debug-info">
    <h4>üêõ Debug Info</h4>
    <button onclick="document.getElementById('debug-info').style.display='none'" 
            style="float: right; background: none; border: none; color: #fff; margin-top: -25px; cursor: pointer;"
            aria-label="Zav≈ô√≠t debug panel">&times;</button>
    <div class="debug-status" id="debug-status">
        <div>Kalend√°≈ô: <span id="debug-calendar">‚ùå</span></div>
        <div>Time slots: <span id="debug-timeslots">‚ùå</span></div>
        <div>URLs: <span id="debug-urls">‚ùå</span></div>
        <div>CSRF: <span id="debug-csrf">‚ùå</span></div>
        <div>M√≠stnost: <span id="debug-room">Nevybr√°no</span></div>
        <div>Datum: <span id="debug-date">Nevybr√°no</span></div>
        <div>ƒåas: <span id="debug-time">Nevybr√°no</span></div>
        <div>Krok: <span id="debug-step">1</span></div>
        <div style="grid-column: 1 / -1; margin-top: 10px; padding-top: 10px; border-top: 1px solid #444;">
            <div>User Agent: <span style="font-size: 0.7rem;">{{ request.META.HTTP_USER_AGENT|truncatechars:30 }}</span></div>
            <div>Debug Mode: <span class="status-ok">‚úÖ</span></div>
        </div>
    </div>
</div>

<script>
    // OPRAVEN√Å DEBUG FUNKCE
    function updateDebugInfo() {
        if (!window.bookingConfig?.debug) return;
        
        try {
            const el = {
                calendar: document.getElementById('debug-calendar'),
                timeslots: document.getElementById('debug-timeslots'),
                urls: document.getElementById('debug-urls'),
                csrf: document.getElementById('debug-csrf'),
                room: document.getElementById('debug-room'),
                date: document.getElementById('debug-date'),
                time: document.getElementById('debug-time'),
                step: document.getElementById('debug-step')
            };
            
            // Check calendar
            if (el.calendar) {
                const hasCalendar = document.getElementById('calendar-grid') && 
                                  document.querySelectorAll('.calendar-day').length > 0;
                el.calendar.innerHTML = hasCalendar ? '<span class="status-ok">‚úÖ</span>' : '<span class="status-error">‚ùå</span>';
            }
            
            // Check time slots
            if (el.timeslots) {
                const hasTimeSlots = document.getElementById('time-slots');
                el.timeslots.innerHTML = hasTimeSlots ? '<span class="status-ok">‚úÖ</span>' : '<span class="status-error">‚ùå</span>';
            }
            
            // Check URLs
            if (el.urls) {
                const hasUrls = window.bookingUrls && window.bookingUrls.getAvailableSlots;
                el.urls.innerHTML = hasUrls ? '<span class="status-ok">‚úÖ</span>' : '<span class="status-error">‚ùå</span>';
            }
            
            // Check CSRF
            if (el.csrf) {
                const csrf = getCookie('csrftoken') || window.bookingConfig?.csrfToken;
                el.csrf.innerHTML = csrf ? '<span class="status-ok">‚úÖ</span>' : '<span class="status-error">‚ùå</span>';
            }
            
            // Check booking state
            if (window.bookingState) {
                if (el.room) el.room.textContent = window.bookingState.roomName || 'Nevybr√°no';
                if (el.date) {
                    const dateText = window.bookingState.selectedDate ? 
                        window.bookingState.selectedDate.toLocaleDateString('cs-CZ') : 'Nevybr√°no';
                    el.date.textContent = dateText;
                }
                if (el.time) el.time.textContent = window.bookingState.selectedTime || 'Nevybr√°no';
                if (el.step) el.step.textContent = window.bookingState.currentStep || '1';
            }
        } catch (error) {
            console.error('Debug update error:', error);
        }
    }
    
    // Helper funkce pro debug
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Update debug info periodicky
    setInterval(updateDebugInfo, 2000);
    setTimeout(updateDebugInfo, 1000);
    
    // Expose debug functions globally
    window.debugBooking = {
        updateDebugInfo: updateDebugInfo,
        showState: () => console.table(window.bookingState),
        clearLocalStorage: () => {
            console.log('Note: localStorage is not used in this implementation for Claude.ai compatibility');
        }
    };
</script>
{% endif %}
{% endblock %}